version: 0.1             
component: build
timeoutInSeconds: 1000
shell: bash           
failImmediatelyOnError: true
env:
  variables:
    "condaurl": "https://objectstorage.us-phoenix-1.oraclecloud.com/p/tmC4mBuowJhvSdy96FzFCi_f-li6wX1QM_giivn7yEujpTdgc6JSqahpabENAGw4/n/ax3dvjxgkemg/b/ds-test-bucket-20230124-1135/o/conda_environments%2Fcpu%2FGeneral%20Machine%20Learning%20for%20CPUs%20on%20Python%203.8%2F1.0%2Fgeneralml_p38_cpu_v1"
  exportedVariables:
    - tag_name: ${image_tag_name}

inputArtifacts:
  - name: oci-config
    type: GENERIC_ARTIFACT
    artifactId: ocid1.genericartifact.oc1.iad.0.amaaaaaanif7xwiapu2zxvrihnzslt2bzxrbn7dsnxp72wnza25qfiip43xq
    location: ${OCI_PRIMARY_SOURCE_DIR}/config
  - name: oci-pem
    type: GENERIC_ARTIFACT
    artifactId: ocid1.genericartifact.oc1.iad.0.amaaaaaanif7xwiawr7j2qfzftl5ow4llzpa3ya6jg5ju2k7p3ushbbhyeda
    location: ${OCI_PRIMARY_SOURCE_DIR}/oci-api.pem

steps:
  - type: Command
    name: "Review build stage params"
    command: |
      echo "Pipeline ID: $OCI_PIPELINE_ID"
      echo "Stage ID: $OCI_STAGE_ID"
      echo "Build Run ID: $OCI_BUILD_RUN_ID"
      echo "Source Directory: $OCI_PRIMARY_SOURCE_DIR"
      # echo "Working Directory: $OCI_WORKING_DIR"
      echo "Conda Env URL: $condaurl"
      echo "Conda Environment: ${conda_env}"
      echo "----- directory listing ----"
      ls -lt

  - type: Command
    name: "Build the container image"
    command: |
      echo "Starting the model server image build ..."
      docker build --build-arg condaurl="$condaurl" --build-arg condaenv="${conda_env}" --build-arg oci_config_filepath="./config" --build-arg oci_pem_filepath="./oci-api.pem" -t oci-ds-model-server .
      echo "Image build completed OK"
   
outputArtifacts:
  - name: oci-ds-model-server
    type: DOCKER_IMAGE
    location: oci-ds-model-server
