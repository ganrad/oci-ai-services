# Name: OCI DevOps build spec file
# Description: This is a build spec file for containerizing the multi-model
# inference server.
#
# Important Notes:
# Update the following variables before running the build pipeline
# condaurl:  Specify the PAR URL (Object Store location) where the Conda Env.
# zip file is stored.
#
# Prior to running the build pipeline, make sure to define the following
# parameters.
# image_tag_name: Image name tag to be assiged to the container image after it
# is built.  The container image will be tagged with this name (~ version) in
# OCI Image Repository.
# conda_env: Name of the Conda environment.  Although this parameter is 
# mandatory, any name can be used.
#
# Author: OCI AI Services product team
# Dated: 02-05-2023
#
# Updates:
#
# ---------------------------------------------------------------------------

version: 0.1             
component: build
timeoutInSeconds: 3600
shell: bash           
failImmediatelyOnError: true
env:
  variables:
    "condaurl": "https://objectstorage.us-phoenix-1.oraclecloud.com/p/tmC4mBuowJhvSdy96FzFCi_f-li6wX1QM_giivn7yEujpTdgc6JSqahpabENAGw4/n/ax3dvjxgkemg/b/ds-test-bucket-20230124-1135/o/conda_environments%2Fcpu%2FGeneral%20Machine%20Learning%20for%20CPUs%20on%20Python%203.8%2F1.0%2Fgeneralml_p38_cpu_v1"
  exportedVariables:
    - tag_name

inputArtifacts:
  - name: oci-config
    type: GENERIC_ARTIFACT
    artifactId: ocid1.genericartifact.oc1.iad.0.amaaaaaanif7xwiapu2zxvrihnzslt2bzxrbn7dsnxp72wnza25qfiip43xq
    location: ${OCI_PRIMARY_SOURCE_DIR}/oci-ai-ds-model-server/config
  - name: oci-pem
    type: GENERIC_ARTIFACT
    artifactId: ocid1.genericartifact.oc1.iad.0.amaaaaaanif7xwiawr7j2qfzftl5ow4llzpa3ya6jg5ju2k7p3ushbbhyeda
    location: ${OCI_PRIMARY_SOURCE_DIR}/oci-ai-ds-model-server/oci-api.pem

steps:
  - type: Command
    name: "Review build stage params"
    command: |
      echo "Pipeline ID: $OCI_PIPELINE_ID"
      echo "Stage ID: $OCI_STAGE_ID"
      echo "Build Run ID: $OCI_BUILD_RUN_ID"
      echo "Source Directory: $OCI_PRIMARY_SOURCE_DIR"
      # echo "Working Directory: $OCI_WORKING_DIR"
      echo "Conda Env URL: $condaurl"
      echo "Conda Environment: ${conda_env}"
      echo "----- List directory contents ----"
      ls -lt ./oci-ai-ds-model-server

  - type: Command
    name: "Build the container image"
    command: |
      tag_name=${image_tag_name}
      echo "Image tag name set to: ${tag_name}"
      echo "Starting the model server image build ..."
      docker build --build-arg condaurl="$condaurl" --build-arg condaenv="${conda_env}" --build-arg oci_config_filepath="./config" --build-arg oci_pem_filepath="./oci-api.pem" -t oci-ds-model-server ./oci-ai-ds-model-server
      echo "Image build completed OK"
   
outputArtifacts:
  - name: oci-ds-model-server
    type: DOCKER_IMAGE
    location: oci-ds-model-server
